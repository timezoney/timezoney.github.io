<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>
<body>
    <a href="#">Back to Catalog</a>
    <p></p>
    <p>(This is a test page to demonstrate that the catalog page successfully passes the post id to the "view post" page)</p>

    <form>
        <input type="text" id="username" placeholder="username" required><br>
        <input type="text" id="fName" placeholder="First Name" required><br>
        <input type="text" id="lName" placeholder="Last Name" required><br>
        <textarea name="message" id="message" placeholder="Enter your respond message" required></textarea><br>
        <button type="submit">Respond to the post</button>
    </form>
    <h4 id="result"></h4>
    <p>(Imitation of different users responding to other users' posts. Later all this information will be gathered from users.json file based on the current user (which is set after registering or logging in))</p>

    <script type="module" defer>
        import { load_user_data, load_post_data, update_user_data } from './data_utils.js'

        let post_id = Number(sessionStorage.getItem('post_id'))
        document.querySelector('body p').innerHTML = `Post ID: ${post_id}`

        let catalog_type = sessionStorage.getItem('last_page');
        if (!catalog_type) {
            catalog_type = './catalog_jobs.html';
        }
        document.querySelector('a').href = `${catalog_type}`


        let all_posts = await load_post_data();
        let current_post = all_posts[all_posts.findIndex(post => post.id == post_id)]

        let all_users = await load_user_data();
        let post_author_user = all_users[all_users.findIndex(user => user.username == current_post.author)]

        document.querySelector('form').addEventListener('submit', async (event) => {
            event.preventDefault()
            let username = document.querySelector('input#username').value
            let fName = document.querySelector('input#fName').value
            let lName = document.querySelector('input#lName').value
            let message = document.querySelector('textarea#message').value

            let new_notification = {
                                    "username": `${username}`,
                                    "fName": `${fName}`,
                                    "lName": `${lName}`,
                                    "message": `${message}`,
                                    "post_id": post_id
                                };
            
            let updated_notifications = [...post_author_user.notifications];
            updated_notifications.push(new_notification);
            let updated_user = {...post_author_user, notifications: updated_notifications};
            await update_user_data(post_author_user.username, updated_user);
            let result_msg = document.querySelector('h4#result')
            result_msg.innerHTML = 'Response sent!';
            setTimeout(() => {
                result_msg.innerHTML = '';
            }, 5000)
        })
    </script>
</body>
</html>